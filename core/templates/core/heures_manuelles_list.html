{% extends "core/base.html" %}

{% block title %}Heures manuelles{% endblock %}

{% block content %}
<div class="card">
  <div class="card__pad">

    <div class="header">
      <div>
        <h1 class="h1">Heures manuelles</h1>
        <p class="sub">Saisies manuelles par agent</p>
      </div>

      <div class="actions">
        <form method="get" class="form" id="hm-filter">
          <div class="field">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}">
          </div>
        </form>
        <div class="actions">
          <button class="btn btn--sm btn--ghost" type="button" id="date-prev">Jour precedent</button>
          <button class="btn btn--sm btn--ghost" type="button" id="date-today">Aujourd'hui</button>
          <button class="btn btn--sm btn--ghost" type="button" id="date-next">Jour suivant</button>
        </div>
        <a href="{% url 'core:heures_manuelles_create' %}" class="btn btn--primary">
          + Nouvelle saisie
        </a>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Agent</th>
            <th>Heure debut</th>
            <th>Heure fin</th>
            <th>Presence</th>
            <th>Motif HS</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for hm in heures_manuelles %}
          <tr>
            <td>{{ hm.date|date:"Y-m-d" }}</td>
            <td>{{ hm.agent }}</td>
            <td>{{ hm.heure_debut|default:"-" }}</td>
            <td>{{ hm.heure_fin|default:"-" }}</td>
            <td>{{ hm.presence|default:"-" }}</td>
            <td>{{ hm.motif_heures_sup|default:"-" }}</td>
            <td class="right">
              <div class="actions">
                <a href="{% url 'core:heures_manuelles_update' hm.id %}" class="btn btn--sm btn--ghost">Modifier</a>
                <a href="{% url 'core:heures_manuelles_delete' hm.id %}" class="btn btn--sm btn--danger">Supprimer</a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="sub">Aucune saisie manuelle</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
<script>
  const dateInput = document.getElementById("date");
  const filterForm = document.getElementById("hm-filter");

  function formatLocalDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  if (dateInput && filterForm) {
    dateInput.addEventListener("change", () => {
      filterForm.submit();
    });
  }

  function shiftDate(days) {
    if (!dateInput || !filterForm) return;
    const base = dateInput.value ? new Date(dateInput.value) : new Date();
    base.setDate(base.getDate() + days);
    dateInput.value = formatLocalDate(base);
    filterForm.submit();
  }

  const btnPrev = document.getElementById("date-prev");
  const btnNext = document.getElementById("date-next");
  const btnToday = document.getElementById("date-today");

  if (btnPrev) btnPrev.addEventListener("click", () => shiftDate(-1));
  if (btnNext) btnNext.addEventListener("click", () => shiftDate(1));
  if (btnToday) {
    btnToday.addEventListener("click", () => {
      if (!dateInput || !filterForm) return;
      dateInput.value = formatLocalDate(new Date());
      filterForm.submit();
    });
  }
</script>
{% endblock %}
