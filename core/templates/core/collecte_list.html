{% extends "core/base.html" %}

{% block title %}Collectes{% endblock %}

{% block content %}
<div class="card">
  <div class="card__pad">

    <div class="header">
      <div>
        <h1 class="h1">Collectes</h1>
        <p class="sub">Liste des collectes enregistrees</p>
      </div>

      <div class="actions">
        <form method="get" class="form" id="collecte-filter">
          <div class="field">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}">
          </div>
        </form>
        <div class="actions">
          <button class="btn btn--sm btn--ghost" type="button" id="date-prev" title="Jour precedent">-1</button>
          <button class="btn btn--sm btn--ghost" type="button" id="date-today" title="Aujourd'hui">Aujourd'hui</button>
          <button class="btn btn--sm btn--ghost" type="button" id="date-next" title="Jour suivant">+1</button>
        </div>
        <a href="{% url 'core:collecte_create' %}" class="btn btn--primary">
          + Nouvelle collecte
        </a>
      </div>
    </div>

    <div class="collecte-cards">
      {% for c in collectes %}
      <div class="collecte-card">
        <div class="collecte-card__head">
          <div class="collecte-card__date">{{ c.date_collecte }}</div>
          <div class="actions">
            <a href="{% url 'core:collecte_detail' c.pk %}" class="btn btn--sm btn--ghost">Voir</a>
            <a href="{% url 'core:collecte_update' c.pk %}" class="btn btn--sm btn--ghost">Modifier</a>
            <a href="{% url 'core:collecte_delete' c.pk %}" class="btn btn--sm btn--danger">Supprimer</a>
          </div>
        </div>
        <div class="collecte-card__body">
          <div class="collecte-grid">
            <div class="collecte-col">
              <div class="collecte-col__title">Agents</div>
              <div class="collecte-col__values">
                <div>{{ c.id_agent_1|default:"-" }}</div>
                <div>{{ c.id_agent_2|default:"-" }}</div>
                <div>{{ c.id_agent_3|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Heures de fin</div>
              <div class="collecte-col__values">
                <div>{{ c.a1_hr_fin|default:"-" }}</div>
                <div>{{ c.a2_hr_fin|default:"-" }}</div>
                <div>{{ c.a3_hr_fin|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Benne</div>
              <div class="collecte-col__values">
                <div>{{ c.id_vehicule|default:"-" }}</div>
                <div>{{ c.km_retour|default:"-" }}</div>
                <div>{{ c.km_depart|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Flux</div>
              <div class="collecte-col__values">
                <div>{{ c.id_flux1|default:"-" }}</div>
                <div>{{ c.id_flux2|default:"-" }}</div>
                <div>{{ c.id_flux3|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Tonnages</div>
              <div class="collecte-col__values">
                <div>{{ c.tonnage1|default:"-" }}</div>
                <div>{{ c.tonnage2|default:"-" }}</div>
                <div>{{ c.tonnage3|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Energies</div>
              <div class="collecte-col__values">
                <div>{{ c.id_energie_1|default:"-" }}</div>
                <div>{{ c.id_energie_2|default:"-" }}</div>
                <div>{{ c.id_energie_3|default:"-" }}</div>
              </div>
            </div>
            <div class="collecte-col">
              <div class="collecte-col__title">Qte</div>
              <div class="collecte-col__values">
                <div>{{ c.energie_qte_1|default:"-" }}</div>
                <div>{{ c.energie_qte_2|default:"-" }}</div>
                <div>{{ c.energie_qte_3|default:"-" }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="card">
        <div class="card__pad sub">Aucune collecte enregistree</div>
      </div>
      {% endfor %}
    </div>

  </div>
</div>
<script>
  const dateInput = document.getElementById("date");
  const filterForm = document.getElementById("collecte-filter");
  if (dateInput && filterForm) {
    dateInput.addEventListener("change", () => {
      filterForm.submit();
    });
  }

  function shiftDate(days) {
    if (!dateInput || !filterForm) return;
    const base = dateInput.value ? new Date(dateInput.value) : new Date();
    base.setDate(base.getDate() + days);
    dateInput.value = base.toISOString().slice(0, 10);
    filterForm.submit();
  }

  const btnPrev = document.getElementById("date-prev");
  const btnNext = document.getElementById("date-next");
  const btnToday = document.getElementById("date-today");
  if (btnPrev) btnPrev.addEventListener("click", () => shiftDate(-1));
  if (btnNext) btnNext.addEventListener("click", () => shiftDate(1));
  if (btnToday) btnToday.addEventListener("click", () => {
    if (!dateInput || !filterForm) return;
    const now = new Date();
    dateInput.value = now.toISOString().slice(0, 10);
    filterForm.submit();
  });
</script>
{% endblock %}
