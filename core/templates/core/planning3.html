{% extends "core/base.html" %}

{% block title %}Planning 3{% endblock %}

{% block content %}
<div class="planning">

  <div class="card">
    <div class="card__pad">
      <div class="header">
        <div>
          <h1 class="h1">Planning 3</h1>
          <p class="sub">Vue mensuelle des heures par agent et par type</p>
        </div>

        <form class="planning__controls" id="planning3Form" method="get">
          <label class="planning__control">
            <span class="planning__label">Date</span>
            <input class="input" type="date" id="dateInput" name="date" value="{{ selected_date|date:'Y-m-d' }}">
          </label>

          <button id="thisMonthBtn" class="btn btn--ghost" type="button">Ce mois ci</button>
          <button id="nextMonthBtn" class="btn btn--ghost" type="button">Mois suivant</button>
          <button id="prevMonthBtn" class="btn btn--ghost" type="button">Mois precedent</button>
        </form>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card__pad">
      <div class="table-wrap planning__wrap">
        <table class="table planning__table planning3__table">
          <thead>
            <tr>
              <th class="planning__sticky planning3__sticky--service">Service</th>
              <th class="planning__sticky planning3__sticky--qualif">Qualification</th>
              <th class="planning__sticky planning3__sticky--nom">Nom agent</th>
              {% for day in days %}
                <th class="planning__cell">{{ day|date:"d" }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
              <tr>
                <td class="planning__sticky planning3__sticky--service">{{ row.agent.service|default:"-" }}</td>
                <td class="planning__sticky planning3__sticky--qualif">{{ row.agent.qualification|default:"-" }}</td>
                <td class="planning__sticky planning3__sticky--nom">{{ row.agent.nom }} {{ row.agent.prenom }}</td>
                {% for entries in row.day_entries %}
                  <td class="planning__cell planning3__cell">
                    {% for e in entries %}
                      <div class="planning3__entry planning3__entry--{{ e.type|slugify }} {{ e.width_class }}" title="{{ e.type }} #{{ e.id_stat }}">
                        {{ e.stat_label }}
                      </div>
                    {% endfor %}
                  </td>
                {% endfor %}
              </tr>
            {% empty %}
              <tr>
                <td colspan="{{ days|length|add:'3' }}" class="sub">Aucun agent sur la periode</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div class="planning-modal" id="planning3HmModal" aria-hidden="true">
  <div class="planning-modal__backdrop" data-close="1"></div>

  <div class="planning-modal__panel planning-modal__panel--wide" role="dialog" aria-modal="true" aria-labelledby="planning3HmModalTitle">
    <div class="planning-modal__head">
      <div>
        <h2 class="h2" id="planning3HmModalTitle" style="margin:0;">Heures manuelles</h2>
        <p class="sub" style="margin:6px 0 0;">Modifier l'entree depuis le planning</p>
      </div>
      <button class="btn btn--ghost btn--sm" type="button" data-close="1">Fermer</button>
    </div>
    <div id="planning3HmContent" class="planning3-modal__body"></div>
  </div>
</div>

<script>
  const dateInput = document.getElementById("dateInput");
  const prevBtn = document.getElementById("prevMonthBtn");
  const nextBtn = document.getElementById("nextMonthBtn");
  const thisMonthBtn = document.getElementById("thisMonthBtn");
  const form = document.getElementById("planning3Form");
  const hmModal = document.getElementById("planning3HmModal");
  const hmContent = document.getElementById("planning3HmContent");
  const hmUpdateUrlTemplate = "{% url 'core:heures_manuelles_update' 0 %}";
  let hmReturnUrl = "";

  function formatLocalDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function setDateAndSubmit(date) {
    if (!dateInput || !form) return;
    dateInput.value = formatLocalDate(date);
    form.submit();
  }

  if (dateInput) {
    dateInput.addEventListener("change", () => {
      if (!dateInput.value) return;
      setDateAndSubmit(new Date(dateInput.value));
    });
  }

  if (thisMonthBtn) {
    thisMonthBtn.addEventListener("click", () => {
      setDateAndSubmit(new Date());
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      const base = dateInput && dateInput.value ? new Date(dateInput.value) : new Date();
      const target = new Date(base.getFullYear(), base.getMonth() + 1, 1);
      setDateAndSubmit(target);
    });
  }

  if (prevBtn) {
    prevBtn.addEventListener("click", () => {
      const base = dateInput && dateInput.value ? new Date(dateInput.value) : new Date();
      const target = new Date(base.getFullYear(), base.getMonth() - 1, 1);
      setDateAndSubmit(target);
    });
  }

  function isHeuresManuellesTitle(title) {
    const t = (title || "").toLowerCase();
    return t.includes("heures") || t.includes("manuel");
  }

  function extractIdFromTitle(title) {
    const match = (title || "").match(/#\s*(\d+)/);
    return match ? match[1] : "";
  }

  function buildHeuresManuellesUpdateUrl(id) {
    return hmUpdateUrlTemplate.replace("/0/", `/${id}/`);
  }

  function closeHeuresManuellesModal() {
    if (!hmModal) return;
    hmModal.setAttribute("aria-hidden", "true");
    if (hmContent) hmContent.innerHTML = "";
  }

  function bindEmbeddedHeuresForm() {
    if (!hmContent) return;
    const embeddedForm = hmContent.querySelector("form");
    if (!embeddedForm) return;

    embeddedForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      const action = embeddedForm.getAttribute("action") || window.location.href;
      const body = new FormData(embeddedForm);
      const response = await fetch(action, {
        method: "POST",
        body,
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });

      if (response.redirected || response.url.includes("/planning3/")) {
        window.location.href = hmReturnUrl || response.url;
        return;
      }

      hmContent.innerHTML = await response.text();
      bindEmbeddedHeuresForm();
    });
  }

  async function openHeuresManuellesModal(id) {
    if (!hmModal || !hmContent) return;
    hmReturnUrl = `${window.location.pathname}${window.location.search}`;
    const editUrl = buildHeuresManuellesUpdateUrl(id);
    hmContent.innerHTML = '<p class="sub">Chargement du formulaire...</p>';
    hmModal.setAttribute("aria-hidden", "false");

    const response = await fetch(
      `${editUrl}?next=${encodeURIComponent(hmReturnUrl)}&embedded=1`,
      { headers: { "X-Requested-With": "XMLHttpRequest" } }
    );
    hmContent.innerHTML = await response.text();
    bindEmbeddedHeuresForm();
  }

  if (hmModal) {
    hmModal.addEventListener("click", (event) => {
      if (event.target?.dataset?.close) {
        closeHeuresManuellesModal();
      }
    });
  }

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && hmModal && hmModal.getAttribute("aria-hidden") === "false") {
      closeHeuresManuellesModal();
    }
  });

  document.querySelectorAll(".planning3__entry[title]").forEach((entry) => {
    const title = entry.getAttribute("title") || "";
    if (isHeuresManuellesTitle(title)) {
      entry.classList.add("planning3__entry--editable");
    }
  });

  document.addEventListener("click", (event) => {
    if (event.target?.dataset?.close) {
      closeHeuresManuellesModal();
      return;
    }

    const entry = event.target.closest(".planning3__entry[title]");
    if (!entry) return;

    const title = entry.getAttribute("title") || "";
    if (!isHeuresManuellesTitle(title)) return;

    const id = extractIdFromTitle(title);
    if (!id) return;

    openHeuresManuellesModal(id);
  });
</script>
{% endblock %}
